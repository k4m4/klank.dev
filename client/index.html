<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>klank.dev</title>
    <script src="audioloop.js"></script>
    <style type="text/css" media="screen">
      #editor {
        position: absolute;
        top: 0;
        right: 0;
        left: 0;
        height: 80%;
      }
      #info {
        position: absolute;
        right: 0;
        bottom: 0;
        left: 0;
        height: 20%
      }
    </style>
  </head>
  <body>
    <div id="editor">module Klank.Dev where
-- new to purescript? check out https://www.purescript.org/ for learning resources!
import Prelude
import Data.List ((:), List(..))
import Data.NonEmpty ((:|))
import Data.Typelevel.Num (D1)
import FRP.Behavior (Behavior)
import FRP.Behavior.Audio (AudioUnit, gain', runInBrowser_, sinOsc, speaker)
import Math (pi, sin)

scene :: Behavior Number -> Behavior (AudioUnit D1)
scene time = f <$> time
  where
  f s =
    let
      rad = pi * s
    in
      speaker
        $ ( (gain' 0.1 $ sinOsc (440.0 + (10.0 * sin (2.3 * rad))))
              :| (gain' 0.25 $ sinOsc (235.0 + (10.0 * sin (1.7 * rad))))
              : (gain' 0.2 $ sinOsc (337.0 + (10.0 * sin rad)))
              : (gain' 0.1 $ sinOsc (530.0 + (19.0 * (5.0 * sin rad))))
              : Nil
          )

-- change to true if you use `microphone` above
enableMicrophone = false

-- add a mouse, keyboard or other device here if needed
main = runInBrowser_ (pure scene)
</div>
  <div id="info">
  </div>
    <script
      src="/ace-builds/src-noconflict/ace.js"
      type="text/javascript"
      charset="utf-8"
    ></script>
    <script
      src="/ace-builds/src-noconflict/ext-linking.js"
      type="text/javascript"
      charset="utf-8"
    ></script>
    <script>
      ////////////////////////////// workers
      var n = 8;
      var workers = [];
      for (var i = 0; i < n; i++) {
        var w = new Worker("glpk-worker.js");
        workers.push(w);
        w.queue = [];
        w.onmessage = function (e) {
          if (e.data.initialized) {
            return;
          }
          var s = this.queue.shift();
          var o = e.data;
          return o.result.status !== 5 ? s[1]("Error") : s[0](o.result.vars);
        };
        w.onerror = function (err) {
          var s = this.queue.shift();
          s[1](err);
        };
      }
      var offCb = null;
      var audioCtx = null;
      //////////////////////////////////////
      var terminalWelcome = `# Welcome to klank.dev!
**ðŸ”Š ðŸŽ§ in the browser using PureScript.**
- Press Ctrl-K (Win/Linux) or Command-K (Mac) to play the current audio scene
- Press Ctrl-H (Win/Linux) or Command-H (Mac) to stop playback
- Press Ctrl-J (Win/Linux) or Command-J (Mac) to recompile the scene when you make changes
- Documentaion, feature requests, and issues on [GitHub](https://github.com/mikesol/purescript-audio-behaviors) _ctrl-click on link to open_
`;
      var globalAudioHack = null;
      var editor = ace.edit("editor");
      editor.setOption("showPrintMargin", false);
      editor.setTheme("ace/theme/monokai");
      editor.session.setMode("ace/mode/haskell");

      var info = ace.edit("info");
      info.setReadOnly(true);
      info.setValue(terminalWelcome);
      info.setOption("showPrintMargin", false);
      info.setOption("showLineNumbers", false);
      // info.setOption("showGutter", false);
      info.session.setMode("ace/mode/markdown");
      info.setOptions({
        enableLinking: true
      });
      info.on("linkClick", function() {
        window.open("https://github.com/mikesol/purescript-audio-behaviors");
      });
      var acectx = [editor, info];
      ////////////////////////////
      /////////////////
        


    /////////////////////
      for (var i = 0; i < 2; i++) {
        acectx[i].commands.addCommand({
          name: 'play',
          bindKey: {win: 'Ctrl-K',  mac: 'Command-K'},
          exec: function(editor) {
            if (globalAudioHack.error) {
              info.setValue("> Current audio is in an error state. Please Ctrl-J or Command-J to recompile without errors. Here is the most recent error stack: \n"+globalAudioHack.error);
              return;
            }
            (globalAudioHack.enableMicrophone ? navigator.mediaDevices.getUserMedia({ audio: true }) : Promise.resolve(null)).then(function (mic) {
              audioCtx = new (window.AudioContext || window.webkitAudioContext)();
              audioCtx.audioWorklet.addModule("ps-aud-mul.js").then(function () {
                var now = new Date().getTime();
                var ctr = 0;
                // null for the microphone
                offCb = globalAudioHack.main(15)(10)(audioCtx)(
                  mic
                )({})(workers)(function (timeToSet) {
                  return function (instructions) {
                    return function (ctx) {
                      return function (stream) {
                        return function (sources) {
                          return function (units) {
                            return function () {
                              touchAudio()(timeToSet)(instructions)(ctx)(stream)(
                                sources
                              )(units)();
                            };
                          };
                        };
                      };
                    };
                  };
                })();
              });
            });
          },
          readOnly: true // false if this command should not apply in readOnly mode
        });
        acectx[i].commands.addCommand({
          name: 'stop',
          bindKey: {win: 'Ctrl-H',  mac: 'Command-H'},
          exec: function(editor) {
            offCb ? offCb() : null;
            offCB = null;
            audioCtx ? audioCtx.close() : null;
            audioCtx = null;
          },
          readOnly: true // false if this command should not apply in readOnly mode
        });
        acectx[i].commands.addCommand({
          name: 'compile',
          bindKey: {win: 'Ctrl-J',  mac: 'Command-J'},
          exec: function(editor) {
              info.setValue("# Compiling.\n**Please be patient.**\n_We couldn't afford a spinny animation so this text will have to do._");
              fetch("https://klank-dev.ew.r.appspot.com/", {
                method: 'POST',
                mode: 'cors',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({code: editor.getValue()})
              }).then(function(r){ return r.json();}).then(function(res){
                console.log("Res", res);
                if (res.error) {
                  info.setValue("There was an error compiling your code.\n"+res.error);
                } else {
                  eval(res.res.split("\n").slice(-1).join("\n")+"\nglobalAudioHack = PS[\""+res.moduleName+"\"];");
                  info.setValue("> Successful compilation!\n"+terminalWelcome);
                  globalAudioHack = res;
                }
              }, function(e) {
                console.error(e);
                alert("An unexpected error occurred during compilation. Please try again.");
                info.setValue(terminalWelcome);
              });
          },
          readOnly: true // false if this command should not apply in readOnly mode
        });
      }
      editor.focus();
    </script>
  </body>
</html>
